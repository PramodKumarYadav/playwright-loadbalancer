name: 'Get dynamic playwright matrix'
author: 'Pramod Yadav'
description: 'To get dynamic playwright matrix based on changed files in a PR'
branding:
  icon: 'arrow-left-circle'
  color: 'yellow'


inputs:
  max-runners:  
    description: 'maximum number of runners to be used'
    required: true

outputs:
  dynamic-matrix:
    description: "dynamic matrix to use"
    value: ${{ steps.set-matrix.outputs.dynamic_matrix }}

runs:
  using: "composite"
  steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark Repository as Safe
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
        shell: bash

      - name: Fetch Base Branch
        run: git fetch origin main
        shell: bash

      - name: Calculate total shards to use
        id: calculate-total-shards-to-use
        run: |
          MAX_RUNNER_COUNT=${{ inputs.max-runners }}
          MODIFIED_TEST_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E "\.spec\.ts$|\.test\.ts$" | wc -l)
          TOTAL_TEST_FILE_COUNT=$(git ls-files | grep -E "\.spec\.ts$|\.test\.ts$" | wc -l)
          RATIO=$(awk "BEGIN {print $MODIFIED_TEST_FILES / $TOTAL_TEST_FILE_COUNT}")
          TOTAL_SHARDS=$(awk "BEGIN {print int($RATIO * $MAX_RUNNER_COUNT + 0.999)}")
          if [ $TOTAL_SHARDS -eq 0 ]; then
            TOTAL_SHARDS=1
          fi
          echo "TOTAL_SHARDS: $TOTAL_SHARDS"
          echo "total_shards=$TOTAL_SHARDS" >> $GITHUB_OUTPUT
        shell: bash

      - name: Generate JSON Matrix
        id: set-matrix
        run: |
          TOTAL_SHARDS=${{ steps.calculate-total-shards-to-use.outputs.total_shards }}
          MATRIX_JSON="["
          for i in $(seq 1 $TOTAL_SHARDS); do
            if [ $i -gt 1 ]; then
              MATRIX_JSON+=","
            fi
            MATRIX_JSON+="\"$i\""
          done
          MATRIX_JSON+="]"

          echo "Generated matrix: $MATRIX_JSON"
          echo "dynamic_matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        shell: bash